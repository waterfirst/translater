<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Conference Helper</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --bg-start: #0f0f1a;
            --bg-end: #1a1a2e;
            --primary: #00d2ff;
            --secondary: #3a7bd5;
            --text: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --subtitle-bg: rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Layout */
        .app-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            padding: 15px;
            background: rgba(15, 15, 26, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        h1 {
            font-size: 1.2rem;
            background: linear-gradient(to right, var(--primary), #92effd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        /* Video Area */
        .video-container {
            position: relative;
            flex: 1;
            background: #000;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect for front camera by default */
        }
        
        video.rear-camera {
            transform: scaleX(1);
        }

        /* Overlay UI */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            padding-bottom: 100px; /* Space for controls */
        }

        /* Subtitles */
        .subtitle-area {
            margin-top: auto;
            background: var(--subtitle-bg);
            backdrop-filter: blur(4px);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
            max-height: 40%;
            overflow-y: auto;
        }

        .subtitle-area.active {
            opacity: 1;
        }

        .subtitle-original {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 5px;
            font-style: italic;
        }

        .subtitle-translated {
            font-size: 1.3rem;
            font-weight: 600;
            line-height: 1.4;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* Controls */
        .controls-panel {
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            padding: 15px 20px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
        }

        .settings-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select {
            flex: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
        }

        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .btn {
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: black;
            flex: 2;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        .btn-primary.listening {
            animation: pulse-green 2s infinite;
            background: linear-gradient(45deg, #00ff87, #60efff);
        }

        .btn-icon {
            background: var(--glass-bg);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            padding: 0;
            border: 1px solid var(--glass-border);
        }

        .pulse-indicator {
            width: 10px;
            height: 10px;
            background-color: #00ff87;
            border-radius: 50%;
            display: none;
        }

        .listening .pulse-indicator {
            display: block;
            animation: pulse 1s infinite;
        }

        /* Gallery Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: none;
            flex-direction: column;
            padding: 20px;
        }
        
        .modal.open {
            display: flex;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: white;
            font-size: 1.2rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .gallery-item {
            aspect-ratio: 9/16;
            background: #222;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Fullscreen Image View */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 110;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .image-viewer.open {
            display: flex;
        }
        
        .image-viewer img {
            max-width: 100%;
            max-height: 80%;
        }
        
        .viewer-controls {
            position: absolute;
            bottom: 30px;
            display: flex;
            gap: 20px;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 135, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 135, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 135, 0); }
        }

        /* Utilities */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <h1>Conference Helper</h1>
    <div style="display: flex; gap: 10px;">
        <button id="btn-gallery" class="btn btn-icon">ğŸ–¼ï¸</button>
        <button id="btn-download-logs" class="btn btn-icon">ğŸ“</button>
    </div>
</header>

<div class="app-container">
    <div class="video-container">
        <video id="camera-feed" autoplay playsinline muted></video>
        <canvas id="capture-canvas" style="display: none;"></canvas>
        
        <div class="overlay">
            <div style="text-align: right; margin-top: 10px;">
                <span id="status-indicator" style="background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: none;">ğŸ”´ REC</span>
            </div>
            
            <div id="subtitle-box" class="subtitle-area">
                <div id="subtitle-original" class="subtitle-original"></div>
                <div id="subtitle-translated" class="subtitle-translated">Start speaking...</div>
            </div>
        </div>
    </div>

    <div class="controls-panel">
        <div class="settings-row">
            <select id="select-source-lang">
                <option value="en-US">ğŸ‡ºğŸ‡¸ English</option>
                <option value="ko-KR" selected>ğŸ‡°ğŸ‡· Korean</option>
                <option value="ja-JP">ğŸ‡¯ğŸ‡µ Japanese</option>
                <option value="zh-CN">ğŸ‡¨ğŸ‡³ Chinese</option>
                <option value="de-DE">ğŸ‡©ğŸ‡ª German</option>
                <option value="fr-FR">ğŸ‡«ğŸ‡· French</option>
                <option value="es-ES">ğŸ‡ªğŸ‡¸ Spanish</option>
            </select>
            <span style="color: #666;">â”</span>
            <select id="select-target-lang">
                <option value="en" selected>ğŸ‡ºğŸ‡¸ English</option>
                <option value="ko">ğŸ‡°ğŸ‡· Korean</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ Japanese</option>
                <option value="zh-CN">ğŸ‡¨ğŸ‡³ Chinese</option>
                <option value="de">ğŸ‡©ğŸ‡ª German</option>
                <option value="fr">ğŸ‡«ğŸ‡· French</option>
                <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>
            </select>
        </div>

        <div class="action-row">
            <button id="btn-switch-cam" class="btn btn-icon">ğŸ”„</button>
            <button id="btn-toggle-listen" class="btn btn-primary">
                <div class="pulse-indicator"></div>
                <span id="btn-text">Start Listening</span>
            </button>
            <button id="btn-capture" class="btn btn-icon">ğŸ“¸</button>
        </div>
    </div>
</div>

<!-- Gallery Modal -->
<div id="gallery-modal" class="modal">
    <div class="modal-header">
        <span>Captured Moments</span>
        <span id="close-gallery" style="cursor: pointer;">âœ–</span>
    </div>
    <div id="gallery-grid" class="gallery-grid">
        <!-- Images go here -->
    </div>
</div>

<!-- Image Viewer -->
<div id="image-viewer" class="image-viewer">
    <img id="viewer-img" src="" alt="View">
    <div class="viewer-controls">
        <button id="btn-download-img" class="btn btn-primary" style="width: auto; padding: 10px 30px;">Download</button>
        <button id="close-viewer" class="btn btn-icon">âœ–</button>
    </div>
</div>

<script>
    // --- State ---
    const state = {
        isListening: false,
        sourceLang: 'ko-KR',
        targetLang: 'en',
        cameraFacingMode: 'user', // 'user' or 'environment'
        stream: null,
        logs: [], // {time, original, translated}
        gallery: [], // blobs
        recognition: null,
        subtitleTimeout: null
    };

    // --- DOM Elements ---
    const video = document.getElementById('camera-feed');
    const subtitleBox = document.getElementById('subtitle-box');
    const originalText = document.getElementById('subtitle-original');
    const translatedText = document.getElementById('subtitle-translated');
    const btnToggleListen = document.getElementById('btn-toggle-listen');
    const btnText = document.getElementById('btn-text');
    const btnSwitchCam = document.getElementById('btn-switch-cam');
    const btnCapture = document.getElementById('btn-capture');
    const selectSource = document.getElementById('select-source-lang');
    const selectTarget = document.getElementById('select-target-lang');
    const galleryModal = document.getElementById('gallery-modal');
    const btnGallery = document.getElementById('btn-gallery');
    const closeGallery = document.getElementById('close-gallery');
    const galleryGrid = document.getElementById('gallery-grid');
    const imageViewer = document.getElementById('image-viewer');
    const viewerImg = document.getElementById('viewer-img');
    const closeViewer = document.getElementById('close-viewer');
    const btnDownloadImg = document.getElementById('btn-download-img');
    const btnDownloadLogs = document.getElementById('btn-download-logs');
    const canvas = document.getElementById('capture-canvas');

    // --- Camera Logic ---
    async function startCamera() {
        if (state.stream) {
            state.stream.getTracks().forEach(track => track.stop());
        }
        
        try {
            const constraints = {
                video: {
                    facingMode: state.cameraFacingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            state.stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = state.stream;
            
            // Apply mirror effect only for front camera
            if (state.cameraFacingMode === 'user') {
                video.style.transform = 'scaleX(-1)';
            } else {
                video.style.transform = 'scaleX(1)';
            }
        } catch (err) {
            console.error("Camera Error:", err);
            alert("Could not access camera. Please ensure permissions are granted.");
        }
    }

    btnSwitchCam.addEventListener('click', () => {
        state.cameraFacingMode = state.cameraFacingMode === 'user' ? 'environment' : 'user';
        startCamera();
    });

    // --- Speech Recognition ---
    function initSpeech() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("Web Speech API is not supported in this browser. Please use Chrome or Edge.");
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        state.recognition = new SpeechRecognition();
        state.recognition.continuous = true;
        state.recognition.interimResults = true;
        state.recognition.lang = state.sourceLang;

        state.recognition.onstart = () => {
            state.isListening = true;
            updateUIState();
        };

        state.recognition.onend = () => {
            if (state.isListening) {
                // Auto restart if it was supposed to be running
                state.recognition.start();
            } else {
                updateUIState();
            }
        };

        state.recognition.onresult = async (event) => {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            // Update UI with interim
            showSubtitles(interimTranscript || finalTranscript, true);

            if (finalTranscript) {
                await handleTranslation(finalTranscript);
            }
        };

        state.recognition.onerror = (event) => {
            console.error("Speech Error:", event.error);
            if (event.error === 'not-allowed') {
                state.isListening = false;
                updateUIState();
                alert("Microphone permission denied.");
            }
        };
    }

    // --- Translation Logic ---
    async function handleTranslation(text) {
        if (!text.trim()) return;

        showSubtitles(text, true); // Show original as interim while fetching

        try {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${state.targetLang}&dt=t&q=${encodeURIComponent(text)}`;
            const res = await fetch(url);
            const data = await res.json();
            
            // Combine all parts of translation
            const translated = data[0].map(item => item[0]).join('');
            
            showSubtitles(text, false, translated);
            saveLog(text, translated);

        } catch (err) {
            console.error("Translation Error:", err);
            showSubtitles(text, false, "[Translation Failed]");
        }
    }

    function showSubtitles(original, isInterim = false, translated = null) {
        clearTimeout(state.subtitleTimeout);
        subtitleBox.classList.add('active');

        if (isInterim) {
            originalText.textContent = "";
            translatedText.textContent = original;
            translatedText.style.color = "#ccc"; // Interim look
            translatedText.style.fontStyle = "italic";
        } else {
            originalText.textContent = original;
            translatedText.textContent = translated;
            translatedText.style.color = "#fff";
            translatedText.style.fontStyle = "normal";
        }

        // Auto hide after 5 seconds of inactivity
        state.subtitleTimeout = setTimeout(() => {
            subtitleBox.classList.remove('active');
        }, 5000);
    }

    // --- Controls Logic ---
    btnToggleListen.addEventListener('click', () => {
        if (state.isListening) {
            state.isListening = false;
            state.recognition.stop();
        } else {
            state.recognition.lang = selectSource.value;
            state.recognition.start();
        }
        updateUIState();
    });

    selectSource.addEventListener('change', () => {
        state.sourceLang = selectSource.value;
        if (state.isListening) {
            state.recognition.stop(); // Will restart with new lang due to auto-restart logic or manual restart needed?
            // Actually onend checks state.isListening. 
            // Better to explicitly restart
            state.recognition.lang = state.sourceLang;
        }
    });

    selectTarget.addEventListener('change', () => {
        state.targetLang = selectTarget.value;
    });

    function updateUIState() {
        if (state.isListening) {
            btnToggleListen.classList.add('listening');
            btnText.textContent = "Listening...";
        } else {
            btnToggleListen.classList.remove('listening');
            btnText.textContent = "Start Listening";
        }
    }

    // --- Logging ---
    function saveLog(original, translated) {
        const time = new Date().toLocaleTimeString();
        state.logs.push({ time, original, translated });
    }

    btnDownloadLogs.addEventListener('click', () => {
        if (state.logs.length === 0) {
            alert("No logs to save yet.");
            return;
        }
        let content = "Time | Original | Translated\n";
        content += "----------------------------\n";
        state.logs.forEach(log => {
            content += `${log.time} | ${log.original} | ${log.translated}\n`;
        });
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `conference_log_${Date.now()}.txt`;
        a.click();
    });

    // --- Screenshot Logic ---
    btnCapture.addEventListener('click', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');

        // Draw video
        if (state.cameraFacingMode === 'user') {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Reset transform
        ctx.setTransform(1, 0, 0, 1, 0, 0);

        // Draw subtitles if active
        if (subtitleBox.classList.contains('active')) {
            const text = translatedText.textContent;
            if (text) {
                // Dim background for text
                const padding = 20;
                const fontSize = 40;
                ctx.font = `600 ${fontSize}px Arial`;
                const textWidth = ctx.measureText(text).width;
                const boxHeight = fontSize + 40;
                const yPos = canvas.height - 100;

                ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                ctx.fillRect(0, yPos - boxHeight + 20, canvas.width, boxHeight);

                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.fillText(text, canvas.width / 2, yPos);
                
                // Draw Original text smaller above
                const origText = originalText.textContent;
                if(origText) {
                     ctx.font = `italic 30px Arial`;
                     ctx.fillStyle = "#ccc";
                     ctx.fillText(origText, canvas.width / 2, yPos - 50);
                }
            }
        }

        // Add Timestamp
        ctx.font = "20px Arial";
        ctx.fillStyle = "white";
        ctx.textAlign = "right";
        ctx.fillText(new Date().toLocaleString(), canvas.width - 20, 40);

        // Save to gallery
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            addToGallery(url);
        }, 'image/png');
    });

    function addToGallery(url) {
        const div = document.createElement('div');
        div.className = 'gallery-item';
        div.innerHTML = `<img src="${url}">`;
        div.onclick = () => openViewer(url);
        galleryGrid.prepend(div);
        
        // Flash effect on screen
        const flash = document.createElement('div');
        flash.style.position = 'fixed';
        flash.style.top = 0; flash.style.left = 0;
        flash.style.width = '100%'; flash.style.height = '100%';
        flash.style.background = 'white';
        flash.style.opacity = '0.8';
        flash.style.transition = 'opacity 0.2s';
        flash.style.zIndex = 200;
        document.body.appendChild(flash);
        requestAnimationFrame(() => flash.style.opacity = 0);
        setTimeout(() => flash.remove(), 200);
    }

    // --- Gallery UI ---
    btnGallery.addEventListener('click', () => {
        galleryModal.classList.add('open');
    });

    closeGallery.addEventListener('click', () => {
        galleryModal.classList.remove('open');
    });

    function openViewer(url) {
        viewerImg.src = url;
        imageViewer.classList.add('open');
        btnDownloadImg.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `capture_${Date.now()}.png`;
            a.click();
        };
    }

    closeViewer.addEventListener('click', () => {
        imageViewer.classList.remove('open');
    });

    // --- Init ---
    window.addEventListener('load', () => {
        startCamera();
        initSpeech();
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered'))
                .catch(err => console.log('SW Failed', err));
        }
    });

</script>
</body>
</html>
